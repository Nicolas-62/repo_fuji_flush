#{extends 'main.html' /}
#{set title:'Current Game' /}

<nav class="navigation">
    <a href="@{Application.gameRoom()}" class="navigation-item"> Back to Game Room </a>
</nav>

<div id="currentGame">
    #{if !game.isFinished}

        <h3>Current Game</h3>


    <button class="leavebtn"><a href="@{Application.leave(game.uuid)}">Quit game</a></button>


    <table class="table-game">
        <thead>
        <td> NICKNAME </td>
        <td> CARDS </td>
        <td> BOARD </td>
        </thead>

        <tbody>
        #{list items:game.hands, as:'aHand'}
        <!-- OTHER PLAYER -->
        #{if !aHand.equals(handPlayer)}
        #{if game.currentPlayer.equals(aHand.player)}
        <!-- JOUEUR COURANT -->
        <tr class="currentPlayer" data-playerid="${aHand.player.id}">
            #{/if}
            #{else}
            <!-- JOUEUR NON COURANT -->
        <tr class="otherPlayer" data-playerid="${aHand.player.id}">
            #{/else}

            <!-- NICKNAME -->
            <td class="column-nickname">
                ${aHand.player.nickName}
                #{if aHand.hasLeft}<span>Left the game</span>#{/if}
            </td>

            <!-- CARDS -->
            <td class="column-cards">
                #{list items:aHand.cards, as:'aCard'}
                <img src="/public/images/png/dosv3.png" class="playerCards"/>
                #{/list}
            </td>

            <!-- BOARD -->
            #{if aHand.cardP.equals(null)}
                <td>
                    <img src="/public/images/png/dos.png" class="playerCards"/>
                </td>
            #{/if}
            #{else}
                <td class="column-board">
                    <img src="/public/images/png/${aHand.cardP.value}.png" class="playerCards"/>
                </td>
            #{/else}
        </tr>
        #{/if}

        <!-- CONNECTED PLAYER -->
        #{else}
        #{if game.currentPlayer.equals(player)}
        <!-- JOUEUR COURANT -->
        <tr class="currentPlayer" height="80" data-playerid="${aHand.player.id}">
            #{/if}
            #{else}
            <!-- JOUEUR NON COURANT -->
        <tr class="otherPlayer" data-playerid="${aHand.player.id}">
            #{/else}

            <!-- NICKNAME -->
            #{if game.currentPlayer.equals(player)}
            <td class="column-nickname">
                ${player.nickName}
                #{if aHand.hasLeft}<span>Left the game</span>#{/if}
            </td>
            #{/if}
            #{else}
            <td class="column-nickname"> ${player.nickName} </td>
            #{/else}

            <!-- CARDS -->
            <td class="cards">
                #{list items:handPlayer.cards, as:'aCard'}
                #{if game.currentPlayer.equals(player)}
                <a class="playCard" href="@{Application.playCard(handPlayer.id, aCard_index-1, game.uuid)}" data-index="${aCard_index-1}">
                    <img src="/public/images/png/${aCard.value}.png" class="playerCards"/>
                </a>
                #{/if}
                #{else}
                <img src="/public/images/png/${aCard.value}.png" class="playerCards"/>
                #{/else}
                #{/list}
            </td>

            <!-- BOARD -->
            #{if aHand.cardP.equals(null)}
                <td>
                    <img src="/public/images/png/dos.png" class="playerCards"/>
                </td>
            #{/if}
            #{else}
                <td class="column-board">
                    <img src="/public/images/png/${handPlayer.cardP.value}.png" class="playerCards"/>
                </td>
            #{/else}

        </tr>
        #{/else}
        #{/list}
        </tbody>
    </table>
</div>
#{/if}

#{else}
<h1> ${game.winners.player.nickName} WON THE GAME, CONGRATULATIONS</h1>
#{/else}

<script type="text/javascript" charset="${_response_encoding}">
$(document).ready(function(){
    // Create a socket
    var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket;
    var socket = new WS('@@{WebSocket.GameSocket.join(game.uuid, handPlayer.id, player.nickName)}');
    const connectedPlayerId = "${player.id}";
    console.log("connectedPlayerId "+connectedPlayerId);
    $('#currentGame').on('click',  '.playCard', function(e){
        e.preventDefault();
        let cardIndex = $(this).attr('data-index');
        console.log("index : "+cardIndex);
        socket.send(cardIndex);

    });

    socket.onmessage = function(event) {
        console.log(event.data);
        const game = JSON.parse(event.data);
        const hands = Object.values(game.hands);

        console.log("game : " + game.currentPlayerId);
        console.log("game : " + game.hands);
        var i =0;
        if(!game.isFinished){
            $('tbody').find('tr').each(function(){
                let $this=$(this);
                hands.forEach(hand => {
                    console.log("data-playerid "+$this.attr('data-playerid').value);
                    console.log("hand-playerId "+hand.playerId);
                    if($this.attr('data-playerid').value == hand.playerId){
                        i++;
                        console.log("tr player found "+i);
                        if(game.currentPlayer == playerId){
                            $this.removeClass("otherPlayer");
                            $this.addClass("currentPlayer");
                        }else{
                            $this.removeClass("currentPlayer");
                            $this.addClass("otherPlayer");                    
                        }
                        if(hand.hasLeft){
                            $this.find('.column-nickname').append(`<span>Left the game</span`);
                        }
                        if(hand.playerId == connectedPlayerId){
                            console.log("connectedPlayer found");
                            const cards = Object.values(hand.cards);
                            $this.find('.playCard').each(cards, function(card){
                                $(this).find('imag').attr("src", "/public/images/png/"+card.value+".png");
                            });
                        }
                        if(hand.carP != "null"){
                             $this.find('.column-board img').attr("src", "/public/images/png/"+hand.cardP+".png");
                        }
                        else{
                            $this.find('.column-board img').attr("src", "/public/images/png/dos.png");
                        }
                            
                    }
                });
            });
        }
    }


});
</script>
